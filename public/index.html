<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Talk Talk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #00b0ff;
      --primary-dark: #0077c2;
      --success: #00c853;
      --background: #eef5fa;
      --chat-bg: #fff;
      --radius: 12px;
      --shadow: 0 6px 32px 3px #6dcfff33, 0 2px 7px #0077c210;
    }
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: var(--background);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px;
      height: 100vh;
    }
    #container {
      display: flex;
      flex-direction: column;
      max-width: 900px;
      width: 100%;
      height: 100%;
      background: var(--chat-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    h2 {
      margin: 16px 0 8px 0;
      text-align: center;
      font-weight: 700;
      color: var(--primary);
      font-size: 2rem;
      user-select: none;
      flex-shrink: 0;
      padding: 0 16px;
    }
    #callscreen {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      padding: 8px 12px 12px 12px;
      overflow: hidden;
    }
    #video-area {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      height: 260px;
      min-height: 260px;
      max-height: 260px;
      margin-bottom: 8px;
    }
    .video-container {
      flex: 1 1 50%;
      background: #000;
      border-radius: var(--radius);
      position: relative;
      box-shadow: 0 2px 12px #0009;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--radius);
      background: black;
    }
    #local-video {
      /* Mirror the local camera horizontally for natural feeling */
      transform: scaleX(-1);
    }
    .video-label {
      position: absolute;
      bottom: 6px;
      left: 12px;
      background: rgba(0, 0, 0, 0.5);
      color: #eee;
      font-weight: 600;
      font-size: 0.9rem;
      padding: 2px 10px;
      border-radius: 10px;
      user-select: none;
      pointer-events: none;
    }
    #waiting {
      flex-shrink: 0;
      color: var(--primary-dark);
      text-align: center;
      font-size: 1rem;
      letter-spacing: 1px;
      font-weight: 600;
      user-select: none;
      margin-bottom: 6px;
      height: 26px;
    }
    #waiting::after {
      content: "‚è≥";
      animation: dots 1.4s steps(3) infinite;
      margin-left: 6px;
    }
    @keyframes dots {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }
    #split {
      flex-grow: 1;
      display: flex;
      border-top: 1.5px solid #e3ecf6;
      border-bottom: 1.5px solid #e3ecf6;
      border-radius: 0 0 var(--radius) var(--radius);
      overflow: hidden;
      background: #f3fafc;
      min-height: 140px;
      max-height: 100%;
      /* Make sure the split area can shrink but grows */
      flex-basis: auto;
      min-width: 0; /* prevent flex overflow */
    }
    .pane {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 8px 12px;
      min-width: 0; /* prevent overflow */
    }
    .pane.you {
      background: #eaf8ff;
      border-right: 1px solid #daecf7;
    }
    .pane.stranger {
      background: #eafcf4;
    }
    .header-label {
      font-weight: bold;
      color: #969;
      margin-bottom: 6px;
      font-size: 1rem;
      text-align: center;
      user-select: none;
    }
    .msg-bubble {
      margin-bottom: 5px;
      padding: 8px 12px;
      border-radius: 16px;
      max-width: 90%;
      word-break: break-word;
      font-size: 0.88rem;
      box-shadow: 0 1.5px 5px #156db719;
    }
    .bubble-you {
      background: linear-gradient(97deg, #e2f7ff 70%, #d1f3ff 100%);
      color: var(--primary-dark);
      margin-left: 0;
      margin-right: auto;
      align-self: flex-start;
    }
    .bubble-stranger {
      background: linear-gradient(100deg, #e6ffe9 75%, #d9faed 100%);
      color: var(--success);
      margin-right: 0;
      margin-left: auto;
      align-self: flex-end;
    }
    .system-msg {
      font-style: italic;
      font-size: 0.85rem;
      color: #888;
      text-align: center;
      margin: 8px 0;
      user-select: none;
    }
    #box {
      flex-shrink: 0;
      display: flex;
      gap: 8px;
      padding: 4px 12px 0 12px;
      background: #fff;
      border-radius: 0 0 var(--radius) var(--radius);
      align-items: center;
    }
    #msg {
      flex: 1;
      border: 1.2px solid #c9e7f8;
      border-radius: 24px;
      padding: 8px 14px;
      font-size: 1rem;
      outline: none;
      background-color: #fafdff;
      transition: border-color 0.2s;
      min-width: 100px;
      max-width: 100%;
    }
    #msg:focus {
      border-color: var(--primary);
      background-color: #f3fbfc;
    }
    button.action-btn {
      min-width: 72px;
      padding: 7px 14px;
      font-size: 0.9rem;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      box-shadow: 0 2px 8px #08a3e71a;
      white-space: nowrap;
      user-select: none;
      transition: background 0.15s ease;
    }
    button.action-btn:disabled {
      background: #aad7ed !important;
      cursor: not-allowed;
      opacity: 0.5;
    }
    #send {
      background: var(--primary);
    }
    #skip {
      background: #fa902d;
      min-width: 84px;
    }
    #terminate {
      background: #df263c;
      min-width: 95px;
    }
    #start {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 360px;
      width: 90vw;
      padding: 14px 0;
      font-size: 1.1rem;
      font-weight: 700;
      background: linear-gradient(101deg, #00b0ff 80%, #00dfa2 100%);
      color: white;
      border: none;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      cursor: pointer;
      z-index: 150;
      user-select: none;
      outline: none;
    }
    #start:disabled {
      background: #aad7ed;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .pane::-webkit-scrollbar {
      width: 8px;
    }
    .pane::-webkit-scrollbar-track {
      background: #e3ecf6;
      border-radius: 10px;
    }
    .pane::-webkit-scrollbar-thumb {
      background: #b0d0f6;
      border-radius: 10px;
    }
    .pane::-webkit-scrollbar-thumb:hover {
      background: #7bb0f8;
    }
    @media (max-width: 600px) {
      #video-area {
        flex-direction: column;
        height: 180px;
      }
      .video-container, .video-container:last-child {
        margin: 0 0 12px 0 !important;
        height: 180px;
      }
      #split {
        flex-direction: column;
        max-height: 130px;
        min-height: 130px;
      }
      .pane {
        max-height: 130px;
        min-height: 130px;
        padding: 5px 7px;
      }
      .action-btn {
        font-size: 0.83rem;
        padding: 5px 7px;
        min-width: 54px;
      }
      #msg {
        min-width: 54px;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <h2>Talk Talk</h2>
    <div id="callscreen" style="visibility:hidden; display:flex; flex-direction: column; height: 100%;">
      <div id="video-area">
        <div class="video-container">
          <video id="local-video" autoplay muted playsinline></video>
          <div class="video-label">You</div>
        </div>
        <div class="video-container">
          <video id="remote-video" autoplay playsinline></video>
          <div class="video-label">Stranger</div>
        </div>
      </div>
      <div id="waiting" style="display:none;"></div>
      <div id="split">
        <div class="pane you">
          <div class="header-label">You</div>
          <div id="chat-you"></div>
        </div>
        <div class="pane stranger">
          <div class="header-label">Stranger</div>
          <div id="chat-stranger"></div>
        </div>
      </div>
      <form id="box" autocomplete="off" style="flex: 0 0 auto;">
        <input id="msg" type="text" placeholder="Type your message..." autocomplete="off" disabled />
        <button id="send" class="action-btn" type="submit" disabled>Send</button>
        <button id="skip" class="action-btn" type="button" style="display:none;" disabled>Skip Call</button>
        <button id="terminate" class="action-btn" type="button" disabled>Terminate</button>
      </form>
    </div>
    <button id="start">Start Chat</button>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const localVideo = document.getElementById("local-video");
  const remoteVideo = document.getElementById("remote-video");
  const chatYou = document.getElementById("chat-you");
  const chatStranger = document.getElementById("chat-stranger");
  const msg = document.getElementById("msg");
  const send = document.getElementById("send");
  const skip = document.getElementById("skip");
  const terminate = document.getElementById("terminate");
  const start = document.getElementById("start");
  const waiting = document.getElementById("waiting");
  const box = document.getElementById("box");
  const callscreen = document.getElementById("callscreen");

  let socket;
  let active = false;
  let localStream = null;

  function appendBubble(paneId, text, cls = "msg-bubble bubble-you") {
    const wrap = document.createElement("div");
    wrap.className = cls;
    wrap.textContent = text;
    document.getElementById(paneId).appendChild(wrap);
    document.getElementById(paneId).scrollTop =
      document.getElementById(paneId).scrollHeight;
  }

  function appendSystemMsg(text) {
    [chatYou, chatStranger].forEach((chat) => {
      const div = document.createElement("div");
      div.className = "system-msg";
      div.textContent = text;
      chat.appendChild(div);
    });
    chatYou.scrollTop = chatYou.scrollHeight;
    chatStranger.scrollTop = chatStranger.scrollHeight;
    waiting.textContent = text;
  }

  function resetChat() {
    chatYou.innerHTML = "";
    chatStranger.innerHTML = "";
    msg.value = "";
  }

  function setWaiting(state) {
    waiting.style.display = state ? "" : "none";
    if (!state) waiting.textContent = "";
  }

  function setChatEnabled(state) {
    active = !!state;
    msg.disabled = !state;
    send.disabled = !state;
    skip.disabled = !state;
    if(state) msg.focus();
  }

  function setSkipVisible(state) {
    skip.style.display = state ? "" : "none";
  }

  function setTerminateEnabled(state) {
    terminate.disabled = !state;
  }

  function setStartEnabled(state) {
    start.style.display = state ? "" : "none";
  }

  async function startCamera() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    } catch (err) {
      console.warn("Could not start camera:", err);
    }
  }

  async function stopCamera() {
    if (localStream) {
      localStream.getTracks().forEach((track) => track.stop());
      localStream = null;
      localVideo.srcObject = null;
    }
  }

  start.onclick = async () => {
    setStartEnabled(false);
    callscreen.style.visibility = "visible";
    setWaiting(true);
    resetChat();
    await startCamera();
    setChatEnabled(false);
    setSkipVisible(false);
    setTerminateEnabled(true);

    if (socket) socket.disconnect();

    socket = io('https://abcd1234.ngrok.io');
    setupSocket();
  };

  box.addEventListener('submit', e => {
    e.preventDefault();
    if (!msg.value.trim() || send.disabled) return;
    socket.emit("message", msg.value);
    appendBubble("chat-you", msg.value, "msg-bubble bubble-you");
    msg.value = "";
    msg.focus();
  });

  skip.onclick = () => {
    if (!active) return;
    socket.emit("skip");
    appendSystemMsg("You skipped this stranger. Matching you to another...");
    setWaiting(true);
    setChatEnabled(false);
    setSkipVisible(false);
    resetChat();
  };

  terminate.onclick = () => {
    appendSystemMsg("You have terminated the chat.");
    setChatEnabled(false);
    setSkipVisible(false);
    setTerminateEnabled(false);
    setStartEnabled(true);
    setWaiting(false);
    if (socket) socket.disconnect();
    resetChat();
    callscreen.style.visibility = "hidden";
    stopCamera();
  };

  msg.onkeyup = (e) => {
    if (e.key === "Enter") send.click();
  };

  function setupSocket() {
    socket.on("waiting", () => {
      setWaiting(true);
      setChatEnabled(false);
      setSkipVisible(false);
      appendSystemMsg("Waiting for a stranger...");
    });
    socket.on("chat_start", () => {
      setWaiting(false);
      setChatEnabled(true);
      setSkipVisible(true);
      resetChat();
      appendSystemMsg("Connected to a stranger! Say hi.");
      msg.focus();
    });
    socket.on("message", (m) => {
      appendBubble("chat-stranger", m, "msg-bubble bubble-stranger");
    });
    socket.on("partner_left", () => {
      appendSystemMsg("Stranger disconnected.");
      setWaiting(true);
      setChatEnabled(false);
      setSkipVisible(false);
    });
    socket.on("disconnect", () => {
      appendSystemMsg("Disconnected from server.");
      setWaiting(false);
      setStartEnabled(true);
      setChatEnabled(false);
      setSkipVisible(false);
      setTerminateEnabled(false);
    });
  }
</script>

</body>
</html>

